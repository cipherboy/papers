\documentclass[10pt,twocolumn,twoside]{pnas-new}
% Use the lineno option to display guide line numbers if required.
% Note that the use of elements such as single-column equations
% may affect the guide line number alignment.

\templatetype{pnasmathematics} % Choose template
% {pnasresearcharticle} = Template for a two-column research article
% {pnasmathematics} = Template for a one-column mathematics article
% {pnasinvited} = Template for a PNAS invited submission

\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{amsmath,amsthm,amssymb,enumerate,euscript,mathrsfs}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{lemma}[theorem]{Lemma}


\title{A Collection of Thoughts on the Keccak/SHA-3 Construction}

% Use letters for affiliations, numbers to show equal authorship (if applicable) and to indicate the corresponding author
\author{Alexander Scheel}

\affil{Iowa State University}

% Please give the surname of the lead author for the running footer
\leadauthor{Scheel}

% Please add here a significance statement to explain the relevance of your work

% Please include corresponding author, author contribution and author declaration information
\correspondingauthor{E-mail: alexander.m.scheel\@gmail.com}

% Keywords are not mandatory, but authors are strongly encouraged to provide them. If provided, please include two to five keywords, separated by the pipe symbol, e.g:

\begin{abstract}
    % TODO
    TODO
\end{abstract}

\keywords{MATH 490 $|$ Advisor: Dr. Clifford Bergman $|$ SHA-3 $|$ hash\_framework }

\begin{document}

% Optional adjustment to line up main text (after abstract) of first page with line numbers, when using both lineno and twocolumn options.
% You should only change this length when you've finalised the article contents.
\verticaladjustment{-2pt}

\maketitle
% \thispagestyle{firststyle}
% \ifthenelse{\boolean{shortarticle}}{\ifthenelse{\boolean{singlecolumn}}{\abscontentformatted}{\abscontent}}{}

% Bibliography
% \bibliography{pnas-sample}

\section{A Series of Introductions} \label{sec:intro}
    This paper presents the work of the author towards the completion of the
requirements for the MATH 490 Independent Study course under Dr. Clifford
Bergman at Iowa State University of Science and Technology. This work was an
extension of the author's Honors Project under Dr. Eric Bergman and utilized
the resulting
\href{https://github.com/cipherboy/hash\_framework}{hash\_framework} project.
Additional artifacts related to this project can be seen in the
\href{https://github.com/cipherboy/keccak-attacks}{keccak-attacks} repository.

    Within this section are a series of introductions which provide necessary
background on the topics of cryptography, hash functions, the development of
Keccak/SHA-3, and its structure. While certain sections can be skipped if the
reader has the prerequisite knowledge, hopefully all readers find the material
engaging and useful. Following these introductions, this paper presents the
analysis of the Keccak/SHA-3 hash function before concluding with a final
evaluation and further work.

% TODO
% More information about structure of analysis section.


\subsection{Introduction on the Topics of Cryptography} \label{sec:i:crypto}

    While there are many applications of pure mathematics, few are as
demanding and shrouded in secrecy as cryptography. Cryptography exists
because of the fundamental need of civilizations, governments, and individuals
to keep secrets secure from devoted adversaries. While modern cryptography
combines the disciplines of mathematics, computer science, and computer
engineering, prior to the turn of the 20th century, cryptography lacked much
of its modern rigor.

    Prior to the late 19th century, cryptography was split into three major
branches: ciphers, codes, and stenography.



% TODO Outline
%    - Historic
%        - Ciphers vs Codes
%
%    - Modern
%        - Symmetric
%        - Asymmetric
%        - Hash Functions
%        - Building Protocols

\subsection{Introduction on the Topics of Hash Functions} \label{sec:i:hash}

    Within cryptography's collection of algorithms, few are are as useful as
hash functions have proven to be to cryptographers and non-cryptographers
alike. A hash function maps arbitrary length binary strings to binary strings
of a fixed length.

% TODO Outline
%   - Properties
%   - History of Development
%   - History of Attacks
%   - Modern Theory and Structure

\subsection{Introduction on the Development of Keccak/SHA-3} \label{sec:i:keccak}

    FIPS 202 \cite{NIST202}.

% TODO Outline
%    - Authors Background (keccak team)
%    - Function design goals
%    - NIST Contest
%    - NIST standardization controversy? (sources?)


\subsection{Introduction to Terminology} \label{sec:i:terminology}

This section contains a collection terminology useful for discussing SHA-3
and Boolean Satisfiability.

We define $\Sigma = \{0, 1\}$ to be the alphabet.

We define the set $W = \{1, 2, 4, 8, 16, 32, 64\}$ to be the powers of two
typically used in constructing the Keccak widths; $w=64$ is standardized for
use in SHA-3, though any power of two can be used.

For a given $w \in W$, we define $S_{w} = \Sigma^{25w}$, to be the set of
all binary strings of length $25w$; these represent the possible states (which
are binary strings that map onto an indexible array $A$ described later) and each
round permutation maps $S_{w} \mapsto S_{w}$.

A binary string $s \in S_{w}$ can be indexed directly (in a zero-indexed
manner, i.e., the starting bit of $s$ is denoted $s[0]$), or via a 3
dimensional structure of size 5 by 5 by $w$. This is typically done in
conjunction with an uppercase letter, $A = s$, and then
$A[x, y, z] = s[w(5y + x) + z]$. This is in accordance with
FIPS 202 \cite{NIST202}.

\subsection{Introduction on the Structure of SHA-3} \label{sec:i:structure}

    SHA-3 consists of two parts: a core permutation function, KECCAK-$f$, and
a domain extender, the KECCAK sponge function. As discussed by the Keccak
authors, additional security is given by choosing the permutation functions to
be bijective, though they need not be (the domain need only be $S_{w}$).


% TODO Outline
%   - Sponge Function
%   - State Array
%   - Five functions
%   - Keccak-$f$





\section{Mathematical Properties of the Five Round Functions} \label{sec:properties}

In the following section, we detail various mathematical properties of the five
permutation functions which make up the core round function of Keccak. In most
cases, we seek to provide mathematical proofs of these properties. In all
cases, we rely on external code and Boolean Satisfiability for computerized
proofs of these theorems, in ways independent of the ways proved here. In a
few cases, we provide references into the existing literature.

% TODO Outline
%   - Outline following subsections

\subsection{Properties of $\theta$} \label{sec:p:t}

% TODO Outline
%   - Theta -> XOR with 11 different values; linear equations?
%   - What sizes are bijective?
%   - Discussion in literature

In this section, we show that $\theta$ is bijective, that XOR distributes
through $\theta$, give a method for finding the inverse of $\theta$, and
give the order of $\theta$.

Let $w$ be a fixed power of 2. Since $S_{w}$ is of finite size, it suffices to
show that, $\forall x, y \in S_{w}$,
$x \neq y \Rightarrow \theta(x) \neq \theta(y)$. Assume the hypothesis: then
$x \oplus y \neq 0^{25w}$.

\begin{lemma} \label{lem:p:t:1}
\begin{align*}
    \theta(a) = 0^{25w} \iff a = 0^{25w}
\end{align*}
\end{lemma}
\begin{proof}

This follows from the definition of $\theta$: note that
$\theta(0^{25w}) = 0^{25w}$. If $a \neq 0^{25w}$, then there
exists an index set $I_{1}$ such that $\forall i \in I_{1}$, $a[i] = 1$,
and $\forall j \not\in I_{1}$, $a[j] = 0$. Then $\theta(a) \neq 0^{25w}$,
which follows from the construction of $\theta$. (Note that each output
bit of $\theta$ is composed of the XOR of 11 values in a fixed pattern).

\end{proof}

\begin{lemma} \label{lem:p:t:2}
$\forall a, b \in S_{w}$,
\begin{align*}
    \theta(a \oplus b) = \theta(a) \oplus \theta(b)
\end{align*}
\end{lemma}
\begin{proof}

This follows from the definition of $\theta$: note that $\theta$ is
composed entirely of XORs and that XOR is commutative and associative.

\end{proof}


Combining Lemma \ref{lem:p:t:1} and Lemma \ref{lem:p:t:2}, we have that:

\begin{align*}
    x \oplus y = 0^{25w} & \iff \theta(x \oplus y) = \theta(0^{25w}) \\
        & \iff \theta(x \oplus y) = 0^{25w} \\
        & \iff \theta(x) \oplus \theta(y) = 0^{25w}
\end{align*}

and hence $\theta$ is bijective.


To construct the inverse of $\theta$, note that
$A'[x, y, z] = A[x, y, z] \oplus D[x, z]$; hence,
$A[x, y, z] = A'[x, y, z] \oplus D'[x, z]$ for some $D' = D$. Since $D[x, z]$
is composed of several $C[x, z]$, where
$C[x, z] = \oplus_{y = 0}^{4} A[x, y, z]$, we can similarly define $C'[x, z]$
to be $C'[x, z] = \oplus_{y = 0}^{4} A'[x, y, z]$. Then, we expect the inverse
of $\theta$ to be of a similar form. This reduces to a linear algebra problem
over boolean variables. We know that $D'[x, z] = D[x, z]$ in order to recover
$A[x, y, z]$. Hence we can represent $D[x, z]$ as a series of bits of length
$5 \times w$, where bit $i = z' + 5 \times x'$ is $1$ if and only if
$C[x', z']$ is used in the construction of $D[x, z]$. Further, we can view each
of the $C'[x, z]$ as being the conjunction of three $C[x', z']$ in $A$, and thus
can represent these as bit strings where bit $j = z' + 5\times x'$ is 1 if
and only if $C[x', z']$ is used to construct $C'[x, z]$. (That is,
since $C'[x, z] = \oplus_{y = 0}^{4} A'[x, y, z]$,
$C'[x, z] = \oplus_{y = 0}^{4} (A[x, y, z] \oplus D[x, z])$ and hence
$C'[x, z] = \oplus_{y = 0}^{4} (A[x, y, z] \oplus C[x', z'] \oplus C[x'', z''])$,
and thus $C'[x, z] = C[x, z] \oplus C[x', z'] \oplus C[x'', z'']$, for some
$x, z, x', z', x'', z''$ based on the definition of $\theta$. Thus,
giving each $C'[x, z]$ a constant $c_{x,z}$ for whether it is used in constructing
$D'[x, z]$, we can form a system of linear equations and solve for the
constants $c_{x, z}$ in each expression. Since there are $5 \times w$ variables
and $5 \times w$ equations in each equation for $D'[x, z]$, this can be solved
easily, yielding the inverse of $\theta$.


Lastly, we have computed the order of the permutation $\theta$ for all $w$.
We reproduce them here without proof; they were found by randomized search, and
verified with SAT for $w = 1, 2, 4$ and $8$. In general, the order is given by
the expression $3 \times w$.

\begin{tabular}{c c} \label{tab:p:t:1}
    w & Order \\
    1 & 3 \\
    2 & 6 \\
    4 & 12 \\
    8 & 24 \\
    16 & 48 \\
    32 & 96 \\
    64 & 192 \\
\end{tabular}


\subsubsection{Of $\rho$} \label{sec:p:r}

% TODO Outline
%   - Obvious permutation of bit orders

Since $\rho$ is a simple permutation of the location of bits, it holds that
$\rho(a \oplus b) = \rho(a) \oplus \rho(b)$.

It is obvious that the order of the $\rho$ permutation is $w$: this is obvious
from the construction of $\rho$.

\subsubsection{Of $\pi$} \label{sec:p:p}

% TODO Outline
%   - Obvious: permutation of bit orders

Since $\pi$ is a simple permutation of the location of bits, it holds trivially
that $\pi(a \oplus b) = \pi(a) \oplus \pi(b)$.

It is obvious that the order of the $\pi$ permutation is $24$: this is obvious
from the construction of $\pi$.

\subsubsection{Of $\chi$} \label{sec:p:c}

% TODO Outline
%   - Harder, discussion in literature.

It is non-trivial that the order of the $\chi$ function is a constant 4.
However, this can be verified through the use of SAT to prove that $\chi^{4}$
is the identity function. Hence $\chi^{-1} = \chi^{3}$.

\subsubsection{Of $\iota$} \label{sec:p:i}

% TODO Outline
%   - Obvious: XOR with fixed value.

Note that since $\iota$ is an XOR with a fixed value, it is obvious that
$\iota$ is a bijection: for any $w$, for any $i$, and for all $x \in S_{w}$,
$\iota(\iota(x, i), i) = x$, since $x \oplus \iota_{i} \oplus \iota_{i} = x$.
Hence, $\iota$ is its own inverse and hence $\iota$ is bijective since the
inverse is well defined for all $x \in S_{w}$.

Lastly, note that it is trivial that the order of the $\iota$ permutation is
2 by construction (due to the XOR).

\subsection{Evaluation of the Orders of Composition of Permutations} \label{sec:p:composition}

In this section, we discuss how the above five permutation functions compose,
and the orders of the resulting compositions. We limit our discussion to $w=1$
for the interests of exhaustive search: $2^{25}$ is possible on commodity
hardware, $2^{50}$ would require additional resources. In general, we find that
these permutations interact non-trivially, resulting in cycles of mixed size.
We reproduce these results in the table below:

\begin{tabular}{c c c c c} \label{tab:p:c:1}
    Function & Order & Fixed Points & Number of Cycles & List of Cycles \\
    $\theta$ & 3 & 2097152 & 2 & 1, 3 \\
    $\rho$ & 1 & 33554432 & 1 & 1 \\
    $\pi$ & 24 & 4 & 8 & 1, 2, 3, 4, 6, 8, 12, 24 \\
    $\chi$ & 4 & 32 & 3 & 1, 2, 4 \\
    $\chi \circ \pi$ & 17360392635484575518934418947500880 $\approx 2^{113.741}$ & 3 & 28 & Not Reproduced \\
    $\pi \circ \rho \circ \theta$ & 24 & 4 & 8 & 1, 2, 3, 4, 6, 8, 12, 24 \\
    $\chi \circ \pi \circ \rho \circ \theta$ & 418144575651966378899040573720 $\approx 2^{98.399}$ & 3 & 27 & Not Reproduced \\
    $r_1$ & 320185339723133697023127516600 $\approx 2^{98.014}$ & 0 & 14 & Not Reproduced \\
    $r_2$ & $\approx 2^{130.726}$ & 0 & 12 & Not Reproduced \\
    $r_3$ & $\approx 2^{164.242}$ & 1 & 16 & Not Reproduced \\
    $r_4$ & $\approx 2^{211.609}$ & 0 & 16 & Not Reproduced \\
    $r_5$ & $\approx 2^{131.878}$ & 2 & 16 & Not Reproduced \\
    $r_6$ & $\approx 2^{190.743}$ & 3 & 18 & Not Reproduced \\
    $r_7$ & $\approx 2^{218.017}$ & 0 & 18 & Not Reproduced \\
    $r_8$ & $\approx 2^{190.137}$ & 0 & 18 & Not Reproduced \\
    $r_9$ & $\approx 2^{188.483}$ & 0 & 14 & Not Reproduced \\
    $r_{10}$ & $\approx 2^{154.432}$ & 0 & 19 & Not Reproduced \\
    $r_{11}$ & $\approx 2^{223.948}$ & 1 & 18 & Not Reproduced \\
    $r_{12}$ & $\approx 2^{108.579}$ & 0 & 12 & Not Reproduced \\
    $r_{13}$ & $\approx 2^{209.785}$ & 1 & 18 & Not Reproduced \\
    $r_{14}$ & $\approx 2^{170.621}$ & 0 & 14 & Not Reproduced \\
    $r_{15}$ & $\approx 2^{196.507}$ & 2 & 22 & Not Reproduced \\
    $r_{16}$ & $\approx 2^{172.643}$ & 1 & 16 & Not Reproduced \\
    $r_{17}$ & $\approx 2^{221.160}$ & 1 & 22 & Not Reproduced \\
    $r_{18}$ & $\approx 2^{203.510}$ & 0 & 20 & Not Reproduced \\
    $r_{19}$ & $\approx 2^{250.748}$ & 3 & 20 & Not Reproduced \\
    $r_{20}$ & $\approx 2^{183.937}$ & 1 & 19 & Not Reproduced \\
    $r_{21}$ & $\approx 2^{158.852}$ & 2 & 15 & Not Reproduced \\
    $r_{22}$ & $\approx 2^{111.874}$ & 1 & 12 & Not Reproduced \\
    $r_{23}$ & $\approx 2^{230.807}$ & 0 & 24 & Not Reproduced \\
    $r_{24}$ & $\approx 2^{140.355}$ & 1 & 14 & Not Reproduced
\end{tabular}

Note that, for $w=1$, $\rho$ is the identity function and is thus omitted from
the tables above. Note that $r_{n}$ denotes the first $n$ rounds of SHA-3.

While on first glance, large orders make it appear that the hash function is
strong, SHA-3 also defines an XOF (or eXtensible Output Function) construct.
This allows SHA-3 to act as a pseudo-random number generator: after hashing
an input, the internal state of SHA-3 has reached some value $S$. Suppose we
want to request $m$ bits of state. If $k$ exceeds our security margin $k/2$,
we take $k/2$ bits, permute $S \rightarrow S'$ according to KECCAK-$f$,
and repeat until all $m$ bits have been retrieved.

An ideal permutation function for an $XOF$ would ensure that there exists one
random cycle through all possible states (and thus contain a cycle of $2^{25}$,
in this case). However, the order of the $r_{n}$ rounds of SHA-3 far exceed
$2^{25}$ and all of them have several cycles. This suggests that the actual
security margin of the XOF construct is far less than the theoretical value.
However, this analysis needs to be extended to at least $w=4$ (performing
$2^{100}$ iterations of the hash function core which is not feasible) to
fully verify this.


% TODO Outline
%   - w=1 evaluation
%   - Evaluation of different orderings of trpci

\subsection{Generalizations of $\theta$ and $\chi$} \label{sec:p:generalizations}

% TODO Outline
%   - Evaluation of effect?
%   - Pending eval?


\subsection{Choice of Parameters and Ordering of Composition} \label{sec:p:generalizations}
% TODO Outline
%   - Pending evaluation?


\section{Marginal and Differential Properties of the Five Round Functions} \label{sec:differentials}

% TODO Outline
%   - Overview of why it matters

\subsection{Marginal Properties} \label{sec:d:margin}



% TODO Outline
%   - Overview of why it matters - one round
%   - Can see effect of rho in w increasing
%   - Graphics

\subsection{Differential Properties} \label{sec:d:diff}

% TODO Outline
%   - Graphics
%   - Impact of importance
%   - Show composition order impact if any?

\subsection{Input Margin Impact on Differential Properties} \label{sec:d:input}

% TODO Outline
%   - Graphics
%   - Impact and importance

\subsection{Output Margin Impact on Differential Properties} \label{sec:d:output}

% TODO Outline
%   - Graphics
%   - Impact and importance


\section{Exhaustive Collision Searches} \label{sec:search}

% TODO Outline
%   - Importance
%   - Finding patterns hard
%   - No obvious connection for how to extend w=1 -> w=2
%   - Searches limited

\section{Fixed Point Attacks} \label{sec:fixed}

In this section, we introduce two potential attacks against Keccak/SHA-3 using
fixed points in the underlying round function. However, neither of these
attacks have been proven possible with current analysis except for small values
of $w$ and small numbers of rounds. The first is a possible attack using full
fixed points in the core round function, while the latter describes a category
of partial fixed points.

% TODO Outline
%   - Outline subsections

\subsection{Full Fixed Points} \label{sec:f:full}

% TODO Outline
%   - Probable due to order analysis
%   - Impact, attack

One theoretical attack against SHA-3 is by using a fixed point. If there
existed a state $x$ such that $h(x) = x$, for $h$ the round function, then
for all additional blocks, $h(x | b) = h(x \oplus b)$. While fixed points can
and do occur (see 24-rounds in Table \ref{tab:p:c:1}), using a fixed-point
attack is more subtle in practice: it is unlikely that a fixed point is a valid
block (that is, $x$ contains a suffix that is $0^{m}$ for the current margin,
$m$). Thus one must find a series of blocks $b_1$, $b_2$ such that
$h(b_1) \oplus b_2 = x$; this in turn extends the attack from being
$h(x | b) = h(x \oplus b)$ to:
\begin{align*}
    x = h(h(b_1) \oplus b_2) & \Rightarrow \\
    h(x | b) = h(b_1 | b_2 | b) & = h(b_1 | h_2 \oplus b) \\
    & = h(b_1 | h_2 | 0^{25w} | b)
\end{align*}
However finding $b_1$, $b_2$ amounts to a preimage attack and is thus unlikely
to occur.

For $w=1, 2$, we have verified that no fixed points occur which are valid blocks
for $1 \leq r \leq 24$, where $r$ is the number of rounds, at margins of 4 and
8 bits.




\subsection{Partial Fixed Points} \label{sec:f:partial}

Another theoretical attack is using a partial fixed point. Suppose there
exists a block $x$ such that $h(x) = y$ is also a block (that is, $y$ has
a suffix of $0^{m}$). In this case, the following is a valid collision,
for all blocks $b$:
\begin{align*}
    h(x \oplus b) = h(y | b)
\end{align*}
We have verified the existance of these partial fixed points for small
$w$ and number of rounds. Furthermore, they are more readily found using SAT
than finding a fixed point is.

For $w=1$, we reproduce a table of quantities of partial fixed points per round
below:
\begin{tabular}{c c c c c} \label{tab:f:p:1}
    Rounds & Quantity & Input & Output \\
    1 & 512 & & \\
    2 & 567 & & \\
    3 & 527 & & \\
    4 & 545 & & \\
    5 & 488 & & \\
    6 & 533 & & \\
    7 & 510 & & \\
\end{tabular}
Note that the above table is only for an effective margin of 256-bits (4 bits
when $w=1$). For an effective margin of 512-bits (8 bits), we found no such
partial fixed points. Further, example inputs and outputs are given as natural
numbers versus binary strings for compactness.

The following table describes our limits for finding partial fixed points
across various sizes of $w$, rounds, and whether or not we've been able to
complete an exhaustive search of all such instances.
\begin{tabular}{c c c c c} \label{tab:f:p:2}
    $w$ & Rounds & Exhaustive & Input & Output \\
\end{tabular}


% TODO Outline
%   - More probable
%   - Impact, attack


\section{Conclusions and Further Work} \label{sec:conclusion}

% TODO Outline
%   - SHA-3 Secure, but introduces new attack vectors
%   - Need more in the way of LC for SHA-3-esq functions
%_  - Needs permutation-based cryptanalysis
%   - Differential cryptanalysis not likely to be of much use

\section{Bibliography} \label{sec:bibliography}

\bibliography{thesis}

\end{document}
